using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Verse;
using RimWorld;
using UnityEngine;
using HarmonyLib;
using System.Reflection;
using System.Reflection.Emit; // For OpCodes

namespace MapDrill
{


        [HarmonyPatch(typeof(CompDeepScanner), "DoFind")]
        public static class TargetMethod_Patch
        {
            [HarmonyTranspiler]
            public static IEnumerable<CodeInstruction> Transpiler(IEnumerable<CodeInstruction> codeInstructions)
            {
            var codes = new List<CodeInstruction>(codeInstructions);
            var field = AccessTools.Field(typeof(ThingDef), "deepCountPerCell");
            var generateOuterDictionary = AccessTools.Method(typeof(TargetMethod_Patch), "MyStaticFunction3");

            for (int i = 0; i < codes.Count; i++)
                {

                    if (i>0 && codes[i-1].opcode == OpCodes.Ldloc_2 && codes[i].LoadsField(field)) //OpCodes.Stloc_2
                {



                    codes.Insert(i++, new CodeInstruction(OpCodes.Ldloc_2)); // ThingDef
                    codes.Insert(i++, new CodeInstruction(OpCodes.Ldloc_0)); // Comp for Map
                    codes.Insert(i++, new CodeInstruction(OpCodes.Ldloc_S,6)); // intvec3 for cell
                    codes.Insert(i++, new CodeInstruction(OpCodes.Call, generateOuterDictionary));

                    break; // Only insert once
                    }
            }
            return codes;
        }

        public static void MyStaticFunction3(ThingDef thingdef, CompDeepScanner comp, IntVec3 intvec3)
        {
            //Map map = comp.parent.Map;
            Map map = comp.parent.MapHeld;
            CompDrill_MapDrill newComp = new CompDrill_MapDrill();
            //newComp.UpdateMapResourceDictionaries(thingdef, map, intvec3);
            CompDrill_MapDrill.UpdateMapResourceDictionaries(thingdef, map, intvec3);

            //Log.Message($"thingdef found ---- {thingdef.defName}");
            //Log.Message($"map found ---- {map}");
            //Log.Message($"IntVec3 found ---- x:\t{intvec3.x}\t|\tz:\t{intvec3.z}");
            return;
        }
    }
}
